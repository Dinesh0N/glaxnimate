default:
    before_script:
        - apt-get update -qq
        - apt-get install -y cmake qtbase5-dev libpython3-dev git libqt5svg5-dev python3-pip wget qttools5-dev-tools qttools5-dev
        - git submodule update --init --recursive

variables:
    DEBIAN_FRONTEND: noninteractive

pages:
    image: ubuntu:latest
    stage: deploy
    script:
        - apt-get install -y doxygen graphviz g++ python3-distutils
        - mkdir -p build
        - cd build
        - cmake ..
        - make doxygen
        - make docs_depends_install
        - make docs
    after_script:
        - mv build/docs/site public
        - mv build/coverage public/coverage
        - mv build/docs/html public/doxygen
    artifacts:
        paths:
            - public
    when: always
    only:
        - master
    needs: ["linux:test"]


linux:test:
    image: ubuntu:latest
    stage: build
    script:
        - pip3 install gcovr
        - mkdir build
        - cd build
        - cmake ..
        - make tests_coverage
    artifacts:
        paths:
            - build/coverage
    when: always


linux:build:
    image: ubuntu:latest
    stage: build
    script:
        - mkdir build
        - cd build
        - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        - make AppDir_base
        - wget -c -nv "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
        - chmod a+x linuxdeploy-x86_64.AppImage
        - ./linuxdeploy-x86_64.AppImage --appimage-extract
        - ./squashfs-root/usr/bin/linuxdeploy --appdir AppDir --desktop-file=AppDir/glaxnimate.desktop
        - rm -rf squashfs-root
        - wget -c -nv "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        - chmod a+x appimagetool-x86_64.AppImage
        - ./appimagetool-x86_64.AppImage --appimage-extract
        - ./squashfs-root/usr/bin/appimagetool AppDir
    artifacts:
        paths:
            - build/glaxnimate-x86_64.AppImage
    when: always

